<%! from django.utils.translation import ugettext as _ %>

<%inherit file="../main.html" />

<%namespace name='static' file='../static_content.html'/>

<%! from django.core.urlresolvers import reverse %>
<%! from django.utils import html %>

<%block name="pagetitle">${_("User Survey")}</%block>

<%block name="bodyclass">view-register</%block>

<%block name="js_extra">
  <script type="text/javascript">

    var existing_data = ${existing_data_json};

    $(function() {

      // adding js class for styling with accessibility in mind
      $('body').addClass('js');

      // new window/tab opening
      $('a[rel="external"], a[class="new-vp"]')
      .click( function() {
      window.open( $(this).attr('href') );
      return false;
      });

      // form field label styling on focus
      $("form :input").focus(function() {
        $("label[for='" + this.id + "']").parent().addClass("is-focused");
      }).blur(function() {
        $("label").parent().removeClass("is-focused");
      });

      /* pre-populate field data with any existing_data */

      for (var key in existing_data) {
        $("[name='"+key+"']").val(existing_data[key])
      }

    });

    (function() {

      $('.status.message.submission-error').css("display", "none");

      toggleSubmitButton(true);

      $('#survey-form').on('submit', function() {
        /* validate required fields */

        var $inputs = $('#survey-form :input');

        $('.status.message.submission-error .message-copy').empty();

        var cancel_submit = false;

        $inputs.each(function() {
          /* see if it is a required field and - if so - make sure user presented all information */
          if (typeof $(this).attr("required") !== typeof undefined) {
            var val = $(this).val();
            if (typeof(val) === "string") {
              if (val.trim().length == 0) {
                var field_label = $(this).parent().find("label");
                $(this).parent().addClass('field-error');
                $('.status.message.submission-error .message-copy').append("<li>"+field_label.text()+"</li>");
                cancel_submit = true;
              }
            } else if (typeof(val) === "object") {
              /* for SELECT statements */
              if (val === null || val.length === 0 || val[0] === "") {
                var field_label = $(this).parent().find("label");
                $(this).parent().addClass('field-error');
                $('.status.message.submission-error .message-copy').append("<li>"+field_label.text()+"</li>");
                cancel_submit = true;
              }
            }
          }
        });

        if (cancel_submit) {
          $('.status.message.submission-error').css("display", "block").focus();
          $("html, body").animate({ scrollTop: 0 }, "fast");
          return false;
        }

        toggleSubmitButton(false);
      });

      $('#survey-form').on('ajax:error', function() {
        toggleSubmitButton(true);
      });

      $('#survey-form').on('ajax:success', function(event, json, xhr) {
        var url = json.redirect_url || "${reverse('dashboard')}";
        $('.status.message.submission-error').css("display", "block").focus();
        location.href = url;
      });

      $('#survey-form').on('ajax:error', function(event, jqXHR, textStatus) {
        toggleSubmitButton(true);
        json = $.parseJSON(jqXHR.responseText);
        $('.status.message.submission-error').addClass('is-shown').focus();
        $('.status.message.submission-error .message-copy').html(json.value).stop().css("display", "block");
        $(".field-error").removeClass('field-error');
        $("[data-field='"+json.field+"']").addClass('field-error')
      });
    })(this);

    function toggleSubmitButton(enable) {
      var $submitButton = $('form .form-actions #submit');

      if(enable) {
        $submitButton.
          removeClass('is-disabled').
          removeProp('disabled').
          html("${_('Submit')}");
      }
      else {
        $submitButton.
          addClass('is-disabled').
          prop('disabled', true).
          text("${_(u'Processing...')}");
      }
    }
  </script>
</%block>

<section class="register container">
  <section role="main" class="content">
    <form role="form" id="survey-form" method="post" data-remote="true" action="${postback_url}" novalidate>
      <input type="hidden" name="csrfmiddlewaretoken" value="${ csrf_token }" />
      <input type="hidden" name="_redirect_url" value="${redirect_url}" />

      % if course:
        <h3>${_("PRE-COURSE SURVEY")}</h3>
        <hr />
        <h4><strong>${course.display_org_with_default}&nbsp;${course.display_number_with_default}</strong></h4>
        <h4><strong>${course.display_name}</strong></h4>
        <hr />
      % endif

      <div role="alert" class="status message submission-error" tabindex="-1">
        <h3 class="message-title">${_("You are missing the following required fields:")} </h3>
        <ul class="message-copy"> </ul>
      </div>

      <p class="instructions">
        ${_("Please complete the following form to begin your course. Required fields are marked with an asterisk *.")}
      </p>

      ${survey_form}

      <div class="form-actions">
        <button name="submit" type="submit" id="submit" class="action action-primary action-update" style="width: 50%; margin-right:30px;">${_('Submit')}</button>
        % if not is_required:
          <a href='${optout_redirect_url}'>${_("Cancel and Return to Course")}</a>
        % else:
          <a href='${dashboard_redirect_url}'>${_("Cancel and Return to Dashboard")}</a>
        % endif
      </div>
    </form>
  </section>

    <aside role="complementary">

      <div class="cta">
        <h3>${_('Why do I need to complete this information')}</h3>
        <p>
          ${_('We use this information to tailor our course materials and future offerings to the specific needs of those enrolled.')}
        </p>
      </div>

      <div class="cta">
        <h3>${_('Who can I contact if I have questions?')}</h3>
        <p>
          ${_('If you have any questions about this course or this form, you can contact <a href="{mail_to_link}"">{mail_to_link}</a>.').format(mail_to_link=mail_to_link)}
        </p>
      </div>
    </aside>

</section>
