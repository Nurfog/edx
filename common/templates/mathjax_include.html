## mako
## File:   templates/mathjax_include.html
##
## Note that this file is only used by LMS.
## MathJax configuration for Studio lives in
## cms/js/require-config.js.

## Avoid loading mathjax if already loaded on the page
<%page expression_filter="h"/>

%if context.get('load_mathjax', True):

%if mathjax_mode is not Undefined and mathjax_mode == 'wiki':
<script type="text/javascript">
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      displayMath: [ ['$$','$$'], ["\\[","\\]"]],
      autoload: {
        color: [],
        colorv2: ['color']
      },
      packages: {'[+]': ['noerrors']}
    },
    options: {
      ignoreHtmlClass: 'tex2jax_ignore',
      processHtmlClass: 'tex2jax_process',
      menuOptions: {
        settings: {
          collapsible: true,
          explorer: true
        },
      },
    },
    loader: {
      load: ['input/asciimath', '[tex]/noerrors']
    }
  };

</script>
%else:
<script type="text/javascript">
  window.MathJax = {
    tex: {
      inlineMath: [
        ['\\(','\\)'],
        ['[mathjaxinline]','[/mathjaxinline]']
      ],
      displayMath: [
        ['\\[','\\]'],
        ['[mathjax]','[/mathjax]']
      ],
      autoload: {
        color: [],
        colorv2: ['color']
      },
      packages: {'[+]': ['noerrors']}
    },
    options: {
      ignoreHtmlClass: 'tex2jax_ignore',
      processHtmlClass: 'tex2jax_process',
      menuOptions: {
        settings: {
          collapsible: true,
          explorer: true
          // autocollapse: false, // Not found in v3
        },
      },
    },
    loader: {
      load: ['input/asciimath', '[tex]/noerrors']
    }
  };
</script>
%endif

<script type="text/javascript">
    window.addEventListener('resize', MJrenderer);

    let t = -1;
    let delay = 1000;
    let oldWidth = document.documentElement.scrollWidth;
    function MJrenderer() {
      // don't rerender if the window is the same size as before
      if (t >= 0) {
        window.clearTimeout(t);
      }
      if (oldWidth !== document.documentElement.scrollWidth) {
        t = window.setTimeout(function() {
          oldWidth = document.documentElement.scrollWidth;
          MathJax.typesetClear();
          MathJax.typesetPromise().then(() => $('.MathJax>svg').toArray().forEach(el => {
            if ($(el).width() === 0) {
              $(el).css('max-width', 'inherit');
            }
          }));
          t = -1;
        }, delay);
      }
    };
</script>

<!-- This must appear after all mathjax-config blocks, so it is after the imports from the other templates.
     It can't be run through static.url because MathJax uses crazy url introspection to do lazy loading of
     MathJax extension libraries -->
<script type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.1/es5/tex-mml-svg.js"></script>
%endif
